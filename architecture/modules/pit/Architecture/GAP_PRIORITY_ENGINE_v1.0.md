# GAP PRIORITY ENGINE v1.0

**Module:** PIT (Project Implementation Tracker)  
**Version:** 1.0  
**Status:** Architecture Approved  
**Part:** 1 of 4 — Overview, Inputs, Outputs, Numeric Priority Model

---

## 0. Purpose

The Gap Priority Engine assigns **priority levels** (low, medium, high, critical) to maturity gaps (criterion, MPS, domain) generated by the scoring pipeline. It ensures PIT receives properly ranked, explainable, actionable tasks.

This engine is part of the Maturity → PIT integration workflow.

### Context

When the maturity scoring pipeline identifies gaps between current and target maturity levels, these gaps must be translated into prioritized PIT tasks. The Gap Priority Engine provides a deterministic, transparent, and AI-augmented method for:

- **Ranking gaps** by urgency and impact
- **Explaining priorities** to stakeholders and auditors
- **Automating task creation** with appropriate severity levels
- **Balancing multiple factors** (gap size, evidence quality, risks, regulatory requirements, time exposure)

### Design Principles

1. **Transparency:** Every priority calculation must be explainable
2. **Determinism:** Same inputs → same priority (within AI variance bounds)
3. **Auditability:** All priority decisions must be logged and traceable
4. **Flexibility:** Modifiers can be adjusted per organization without code changes
5. **Integration:** Works seamlessly with existing scoring and PIT workflows

---

## 1. Inputs to the Engine

Each gap object includes the following fields, collected from Supabase scoring tables and maturity configuration:

### Core Identification
- `org_id` (uuid) — Organization identifier
- `cycle_id` (uuid) — Maturity cycle identifier
- `origin_type` (enum) — Type of gap: `criterion` | `mps` | `domain`
- `origin_id` (uuid) — ID of the criterion, MPS, or domain

### Context & Hierarchy
- `domain_name` (text) — Name of the parent domain
- `domain_id` (uuid) — Domain identifier
- `mps_name` (text) — Name of the parent MPS (if applicable)
- `mps_id` (uuid) — MPS identifier (if applicable)
- `criterion_name` (text) — Name of the criterion (if applicable)

### Maturity Metrics
- `current_level` (int 1-5) — Actual maturity level achieved
- `target_level` (int 1-5) — Required maturity level
- `gap` (int) — Difference: `target_level - current_level`
- `numeric_score` (numeric 0.00-1.00) — Calculated maturity score

### Evidence Quality Indicators
- `evidence_count` (int) — Number of evidence items linked to this gap
- `avg_evidence_confidence` (numeric 0.00-1.00) — Average AI confidence score across evidence

### Risk & Impact Factors
- `criticality` (enum) — Business criticality: `low` | `medium` | `high` | `critical`
- `linked_risks` (object) — Associated risk items
  - `count` (int) — Number of linked risks
  - `max_severity` (enum) — Highest risk severity: `low` | `medium` | `high` | `critical`
  - `total_risk_score` (numeric) — Sum of risk scores
- `linked_incidents` (object) — Associated incidents
  - `count` (int) — Number of linked incidents
  - `max_severity` (enum) — Highest incident severity
  - `recent_count` (int) — Incidents in last 90 days

### Regulatory & Compliance
- `regulatory_relevance` (enum) — Regulatory importance: `none` | `moderate` | `high`
- `compliance_frameworks` (array) — List of frameworks requiring this criterion (e.g., ISO 27001, NIST, SOC 2)
- `audit_flags` (array) — Auditor notes or requirements

### Time & History
- `time_exposed_days` (int) — Days since gap was first detected
- `previous_gap` (int | null) — Gap size in previous cycle (for trend analysis)
- `gap_trend` (enum) — Trend: `improving` | `stable` | `worsening` | `new`

### Existing Work
- `existing_pit_tasks` (object) — Current PIT tasks linked to this gap
  - `open_count` (int) — Number of open tasks
  - `closed_count` (int) — Number of closed tasks
  - `overdue_count` (int) — Number of overdue tasks
  - `oldest_task_age_days` (int) — Age of oldest open task

---

## 2. Output of the Engine

The engine outputs a structured priority object for each gap:

```typescript
interface GapPriorityOutput {
  // Original gap reference
  org_id: string;
  cycle_id: string;
  origin_type: 'criterion' | 'mps' | 'domain';
  origin_id: string;
  
  // Calculated priority
  priority_score: number;           // 0.00 - 4.00+ (unbounded upward)
  priority_level: 'low' | 'medium' | 'high' | 'critical';
  
  // Breakdown for transparency
  base_priority: number;            // From gap size
  modifiers: {
    evidence_confidence: number;    // 0.75 - 1.25
    criticality: number;            // 1.0 - 3.0
    linked_risks: number;           // 1.0 - 2.0
    regulatory_relevance: number;   // 1.0 - 1.5
    time_exposed: number;           // 1.0 - 2.0
    existing_tasks: number;         // 0.5 - 1.0
  };
  
  // Recommended handling
  recommended_action: 'defer' | 'create_task' | 'create_project' | 'escalate';
  suggested_due_date: string | null;  // ISO 8601 date
  suggested_owner_role: string | null; // e.g., "domain_owner", "security_manager"
  
  // Audit trail
  calculation_timestamp: string;
  calculation_version: string;      // Engine version used
  explanation: string;              // Human-readable priority justification
}
```

This output determines PIT task creation and is stored for audit and analytics purposes.

---

## 3. Numeric Priority Model

The priority calculation follows a **base + modifiers** approach:

```
final_priority = base_priority × evidence_modifier × criticality_modifier × 
                 risk_modifier × regulatory_modifier × time_modifier × 
                 existing_tasks_modifier
```

### 3.1 Base Priority (from gap)

The base priority is derived from the gap size using a linear scale:

```
base_priority = gap / 4
```

**Rationale:** Maximum gap is 4 (level 1 → level 5), so this normalizes to 0.00-1.00 range.

**Examples:**
- Gap 0 → base_priority = 0.00 (no gap, no priority)
- Gap 1 → base_priority = 0.25
- Gap 2 → base_priority = 0.50
- Gap 3 → base_priority = 0.75
- Gap 4 → base_priority = 1.00

**Edge Cases:**
- Gap < 0: Should not occur; if detected, treat as 0
- Gap > 4: Should not occur in standard model; cap at 1.00

---

### 3.2 Modifiers

Each modifier multiplies the base priority. All modifiers are clamped to their specified ranges.

#### a) Evidence Confidence Modifier

Adjusts priority based on evidence quality. Higher confidence means more trust in the gap assessment.

```
evidence_modifier = 1.0 + (0.70 - avg_evidence_confidence) / 2
// 0.70 is the neutral confidence point (acceptable quality)
// Division by 2 provides gentle scaling: ±0.25 max adjustment
```

**Clamped to:** `[0.75, 1.25]`

**Logic:**
- High confidence (0.90-1.00) → modifier ~0.80-0.90 → **reduces priority** (gap is well-documented, less urgent)
- Medium confidence (0.60-0.70) → modifier ~1.00-1.05 → neutral (0.70 baseline)
- Low confidence (0.00-0.50) → modifier 1.10-1.25 → **increases priority** (gap is uncertain, needs investigation)

**Edge Cases:**
- No evidence (`evidence_count = 0`): Set `avg_evidence_confidence = 0.00` → modifier = 1.25 (maximum increase)
- Single high-quality evidence: Use actual confidence score

**Examples:**
- `avg_evidence_confidence = 0.90` → modifier = 1.0 + (0.70 - 0.90) / 2 = 0.90 (clamped: 0.90)
- `avg_evidence_confidence = 0.50` → modifier = 1.0 + (0.70 - 0.50) / 2 = 1.10
- `avg_evidence_confidence = 0.20` → modifier = 1.0 + (0.70 - 0.20) / 2 = 1.25 (clamped: 1.25)

---

#### b) Criticality Modifier

Reflects the business impact if the gap remains unaddressed.

**Mapping:**
- `criticality = low` → modifier = **1.0**
- `criticality = medium` → modifier = **1.5**
- `criticality = high` → modifier = **2.0**
- `criticality = critical` → modifier = **3.0**

**Rationale:**
- Critical gaps (e.g., access control, incident response) can escalate priority by 3x
- Low criticality gaps (e.g., documentation formatting) maintain base priority

**Source:**
- Criticality is defined at the criterion/MPS/domain level in maturity configuration
- Can be overridden by risk assessments or auditor requirements

---

#### c) Linked Risks Modifier

Increases priority when the gap is associated with high-severity risks.

```
if (linked_risks.count === 0) {
  risk_modifier = 1.0
} else {
  severity_score = mapSeverity(linked_risks.max_severity) // low=1, medium=2, high=3, critical=4
  risk_count_factor = Math.min(linked_risks.count / 5, 0.5)
  // 5 risks = typical threshold for "many risks" in risk management
  // 0.5 cap prevents over-weighting quantity vs. quality
  risk_modifier = 1.0 + (severity_score / 10) + risk_count_factor
}
```

**Clamped to:** `[1.0, 2.0]`

**Examples:**
- No linked risks → modifier = 1.0
- 1 high-severity risk → modifier = 1.0 + 0.3 + 0.2 = 1.5
- 3 critical risks → modifier = 1.0 + 0.4 + 0.6 = 2.0 (clamped)
- 10 low-severity risks → modifier = 1.0 + 0.1 + 0.5 = 1.6

**Rationale:**
- Gaps linked to active, high-severity risks need immediate attention
- Multiple lower-severity risks also warrant increased priority

---

#### d) Regulatory Relevance Modifier

Increases priority for compliance-critical gaps.

**Mapping:**
- `regulatory_relevance = none` → modifier = **1.0**
- `regulatory_relevance = moderate` → modifier = **1.2**
- `regulatory_relevance = high` → modifier = **1.5**

**Additional Rules:**
- If `compliance_frameworks` includes high-priority frameworks (ISO 27001, SOC 2, HIPAA, GDPR), set minimum modifier = 1.3
- If `audit_flags` is not empty, add +0.1 to modifier (auditor attention)

**Examples:**
- Internal best practice, no regulation → modifier = 1.0
- Supports SOC 2 compliance → modifier = 1.3 (framework override)
- Required by GDPR + auditor flag → modifier = 1.5 + 0.1 = 1.6 (clamped to 1.5)

**Clamped to:** `[1.0, 1.5]`

---

#### e) Time Exposed Modifier

Increases priority for long-standing gaps (gap fatigue prevention).

```
if (time_exposed_days <= 30) {
  time_modifier = 1.0       // New gaps, normal priority
} else if (time_exposed_days <= 90) {
  time_modifier = 1.1       // 1 quarter - slight increase
} else if (time_exposed_days <= 180) {
  time_modifier = 1.3       // 2 quarters - moderate increase
} else if (time_exposed_days <= 365) {
  time_modifier = 1.5       // 3-4 quarters - significant increase
} else {
  time_modifier = 2.0       // > 1 year - chronic gap, double urgency
}
```

**Clamped to:** `[1.0, 2.0]`

**Rationale:**
- New gaps (< 30 days) are not yet urgent - allow time for initial assessment
- Gaps persisting 1 quarter (90 days) signal delayed action
- Gaps persisting 2+ quarters (180+ days) indicate systemic barriers
- Gaps > 1 year are chronic and need escalation to leadership
- Thresholds align with quarterly planning cycles common in ISMS programs

**Examples:**
- Gap detected 15 days ago → modifier = 1.0
- Gap detected 120 days ago → modifier = 1.3
- Gap detected 2 years ago → modifier = 2.0

---

#### f) Existing Tasks Modifier

Reduces priority if work is already in progress; increases if tasks are stalled.

```
if (existing_pit_tasks.open_count === 0) {
  existing_tasks_modifier = 1.0  // No tasks, normal priority
} else if (existing_pit_tasks.overdue_count > 0) {
  existing_tasks_modifier = 1.0  // Overdue tasks indicate stalled work, maintain urgency
} else {
  // Active tasks, slightly reduce priority (already being addressed)
  existing_tasks_modifier = 0.9
}
```

**Clamped to:** `[0.5, 1.0]`

**Rationale:**
- If tasks are actively being worked on, don't create duplicate urgent work
- If tasks are overdue, the gap is still urgent despite existing tasks
- If no tasks exist, this is a new gap needing attention

---

### 3.3 Final Priority Calculation

**Formula:**
```
final_priority = base_priority × evidence_modifier × criticality_modifier × 
                 risk_modifier × regulatory_modifier × time_modifier × 
                 existing_tasks_modifier
```

**Example Calculation:**

**Scenario:** Incident Response SOP gap
- Gap: 2 (Level 2 → Level 4)
- Evidence confidence: 0.60 (medium)
- Criticality: high
- Linked risks: 2 high-severity risks
- Regulatory relevance: high (ISO 27001 required)
- Time exposed: 120 days
- Existing tasks: 1 open, 0 overdue

**Calculation:**
```
base_priority = 2 / 4 = 0.50

evidence_modifier = 1.0 + (0.70 - 0.60) / 2 = 1.05
criticality_modifier = 2.0
risk_modifier = 1.0 + (3/10) + (2/5) = 1.0 + 0.3 + 0.4 = 1.7  // high severity + 2 risks
regulatory_modifier = 1.5
time_modifier = 1.3
existing_tasks_modifier = 0.9

final_priority = 0.50 × 1.05 × 2.0 × 1.7 × 1.5 × 1.3 × 0.9
               = 3.13
```

**Result:** Priority score = **3.13** → **Critical** priority level

---

### 3.4 Priority Level Mapping

Final priority scores are mapped to discrete levels for PIT task creation:

| Priority Score | Priority Level | PIT Handling |
|---------------|----------------|--------------|
| 0.00 - 0.50   | **Low**        | Defer or batch with other low-priority tasks |
| 0.51 - 1.50   | **Medium**     | Create task, standard due date (60-90 days) |
| 1.51 - 2.50   | **High**       | Create task, urgent due date (30 days) |
| 2.51+         | **Critical**   | Create task immediately, escalate to leadership, due date ≤ 14 days |

**Additional Rules:**
- Scores < 0.25 may be flagged as "no action required" (false positive check)
- Scores > 4.0 trigger automatic executive notification
- Criticality level `critical` always results in at least `high` priority, regardless of score

---

### 3.5 Recommended Action Derivation

Based on priority score and gap characteristics:

```typescript
function deriveRecommendedAction(
  priority_score: number,
  origin_type: string,
  existing_tasks: object
): RecommendedAction {
  
  if (priority_score < 0.25) {
    return 'defer'; // Very low priority, monitor only
  }
  
  if (existing_tasks.open_count > 0 && existing_tasks.overdue_count === 0) {
    return 'defer'; // Already being worked on
  }
  
  if (priority_score >= 2.5) {
    return 'escalate'; // Critical priority needs leadership attention
  }
  
  if (origin_type === 'domain' || priority_score >= 2.0) {
    return 'create_project'; // Large scope or high priority
  }
  
  return 'create_task'; // Standard gap handling
}
```

---

### 3.6 Explanation Generation

Every priority calculation includes a human-readable explanation for audit and transparency:

**Template:**
```
"Priority {level} ({score}): Gap of {gap} levels from {current_level} to {target_level}. 
{Criticality_reason}. {Risk_reason}. {Regulatory_reason}. {Time_reason}. {Evidence_reason}."
```

**Example:**
```
"Priority Critical (3.16): Gap of 2 levels from Reactive to Proactive. 
This criterion is business-critical. 
Associated with 2 high-severity risks. 
Required by ISO 27001. 
Gap has persisted for 120 days. 
Evidence confidence is moderate (0.60)."
```

---

## 4. Implementation Notes

### 4.1 Data Sources

Inputs are collected from:
- `criteria_scores`, `mps_scores`, `domain_scores` tables (gap, current_level, target_level)
- `evidence_ai_scores` table (avg_evidence_confidence)
- `maturity_configuration` tables (criticality, regulatory_relevance)
- `risk_items` and `incident_cases` tables (linked risks/incidents)
- `pit_tasks` table (existing_pit_tasks)
- Calculated fields (time_exposed_days from first gap detection)

### 4.2 Performance

- Priority calculation should complete in < 100ms per gap
- Batch processing for full cycles: < 5 seconds for 500 criteria
- Cache modifier lookup tables (criticality, regulatory) for 15 minutes

### 4.3 Configuration

Organizations can override default modifier weights in `gap_priority_config`:

```sql
create table gap_priority_config (
  org_id uuid references organizations(id),
  config_key text,
  config_value numeric,
  updated_at timestamptz default now(),
  primary key (org_id, config_key)
);
```

Example overrides:
- `evidence_confidence_weight` (default: 1.0)
- `criticality_critical_multiplier` (default: 3.0)
- `time_exposed_max_multiplier` (default: 2.0)

### 4.4 Versioning

All priority calculations must log:
- `calculation_version` (e.g., "1.0.0")
- `modifier_config_snapshot` (JSON of modifier values used)
- `calculation_timestamp`

This enables:
- Recalculating priorities with updated logic
- Explaining historical priority decisions
- A/B testing new priority models

---

## 5. Next Steps

**Part 2 of 4** — ✅ **COMPLETED** — See `GAP_PRIORITY_ENGINE_AI_REASONING_v1.0.md`

The **AI Reasoning Layer** provides:
- Human-readable interpretation of numeric priority scores
- Factual reasoning summaries explaining priority decisions
- Actionable recommendations for gap closure
- Integration with PIT task creation
- Complete audit trail and explainability

**Part 3 of 4** will define **Recommended Handling & PIT Integration Rules**, including:
- Task vs. project decision logic
- Due date calculation
- Owner assignment
- Deduplication with existing tasks
- Feedback loops

**Part 4 of 4** will define **QA Tests & Validation Requirements**, including:
- Unit test cases for each modifier
- Integration tests with scoring pipeline
- Performance benchmarks
- Edge case handling

---

**Status:** ✅ Architecture Approved  
**Owner:** Foreman  
**Target:** Builder Agents + PIT Implementation Team

---

## References

- **PIT Scoring Integration Workflow:** `architecture/modules/pit/PIT_SCORING_INTEGRATION_WORKFLOW_v1.0.md`
- **PIT Integration Requirements:** `architecture/modules/pit/PIT_INTEGRATION_REQUIREMENTS_v1.0.md`
- **Maturity Scoring Model:** `infrastructure/db/migrations/20250208_scoring_model.sql`
- **Maturity Scoring API Contract:** `architecture/api/MATURITY_SCORING_API_CONTRACT_v1.0.md`

---

**End of Part 1 of 4**
