name: Deploy MAT AI Gateway

on:
  push:
    branches:
      - main
    paths:
      - 'apps/mat-ai-gateway/**'
      - '.github/workflows/deploy-mat-ai-gateway.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'apps/mat-ai-gateway/**'
      - '.github/workflows/deploy-mat-ai-gateway.yml'
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Run flake8
        run: |
          pip install flake8
          flake8 apps/mat-ai-gateway/ --max-line-length=120 --exclude=apps/mat-ai-gateway/tests/__pycache__

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -r apps/mat-ai-gateway/requirements.txt pytest httpx
      - name: Run tests
        working-directory: apps/mat-ai-gateway
        run: python -m pytest tests/ -v

  deploy-preview:
    name: Deploy Preview (Staging)
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger Render staging deploy
        id: trigger-staging-deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID_STAGING: ${{ secrets.RENDER_SERVICE_ID_STAGING }}
        run: |
          if [ -z "$RENDER_SERVICE_ID_STAGING" ]; then
            echo "Render staging deploy skipped -- configure RENDER_SERVICE_ID_STAGING to enable"
            echo "deploy_id=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Triggering Render staging deploy for service $RENDER_SERVICE_ID_STAGING ..."
          RESPONSE=$(curl -s -o /tmp/render-staging-response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID_STAGING/deploys")
          cat /tmp/render-staging-response.json
          if [ "$RESPONSE" != "201" ]; then
            echo "Render staging deploy trigger failed with HTTP $RESPONSE"
            exit 1
          fi
          DEPLOY_ID=$(jq -r '.id // empty' /tmp/render-staging-response.json)
          if [ -z "$DEPLOY_ID" ]; then
            echo "Failed to extract deploy ID from response"
            exit 1
          fi
          echo "deploy_id=$DEPLOY_ID" >> "$GITHUB_OUTPUT"
          echo "Render staging deploy triggered successfully (deploy ID: $DEPLOY_ID)."

      - name: Wait for Render staging deploy to complete
        if: steps.trigger-staging-deploy.outputs.deploy_id != ''
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID_STAGING: ${{ secrets.RENDER_SERVICE_ID_STAGING }}
        run: |
          echo "Waiting for Render staging deploy to reach 'live' status..."
          for i in $(seq 1 40); do
            STATUS=$(curl -s \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$RENDER_SERVICE_ID_STAGING" \
              | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('serviceDetails',{}).get('publishedDeploy',{}).get('status','unknown'))")
            echo "Attempt $i: status=$STATUS"
            if [ "$STATUS" = "live" ]; then
              echo "Staging deploy is live."
              exit 0
            fi
            sleep 15
          done
          echo "Staging deploy did not reach 'live' status within timeout."
          exit 1

      - name: Verify staging health check
        if: steps.trigger-staging-deploy.outputs.deploy_id != ''
        env:
          RENDER_SERVICE_URL_STAGING: ${{ secrets.RENDER_SERVICE_URL_STAGING }}
        run: |
          if [ -z "$RENDER_SERVICE_URL_STAGING" ]; then
            echo "Staging health check skipped -- configure RENDER_SERVICE_URL_STAGING to enable"
            exit 0
          fi
          echo "Verifying health check at $RENDER_SERVICE_URL_STAGING/health ..."
          for i in $(seq 1 5); do
            if curl -fsS --max-time 10 "$RENDER_SERVICE_URL_STAGING/health" > /dev/null; then
              echo "Staging health check passed."
              exit 0
            fi
            echo "Attempt $i failed. Retrying in 10 seconds..."
            sleep 10
          done
          echo "Staging health check failed after 5 attempts."
          exit 1

  deploy-production:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Trigger Render deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Triggering Render deploy for service $RENDER_SERVICE_ID ..."
          RESPONSE=$(curl -s -o /tmp/render-response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys")
          cat /tmp/render-response.json
          if [ "$RESPONSE" != "201" ]; then
            echo "Render deploy trigger failed with HTTP $RESPONSE"
            exit 1
          fi
          echo "Render deploy triggered successfully."

      - name: Wait for Render deploy to complete
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Waiting for Render deploy to reach 'live' status..."
          for i in $(seq 1 20); do
            STATUS=$(curl -s \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$RENDER_SERVICE_ID" \
              | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('serviceDetails',{}).get('publishedDeploy',{}).get('status','unknown'))")
            echo "Attempt $i: status=$STATUS"
            if [ "$STATUS" = "live" ]; then
              echo "Deploy is live."
              exit 0
            fi
            sleep 15
          done
          echo "Deploy did not reach 'live' status within timeout."
          exit 1

      - name: Verify health check
        env:
          RENDER_SERVICE_URL: ${{ secrets.RENDER_SERVICE_URL }}
        run: |
          echo "Verifying health check at $RENDER_SERVICE_URL/health ..."
          for i in $(seq 1 5); do
            if curl -fsS --max-time 10 "$RENDER_SERVICE_URL/health" > /dev/null; then
              echo "Health check passed."
              exit 0
            fi
            echo "Attempt $i failed. Retrying in 10 seconds..."
            sleep 10
          done
          echo "Health check failed after 5 attempts."
          exit 1

  cwt:
    name: Combined Wave Test (MAT-T-0001–0098)
    runs-on: ubuntu-latest
    needs: [deploy-production]
    permissions:
      contents: read
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run Combined Wave Tests (MAT-T-0001–0098)
        shell: bash
        run: set -o pipefail && npm test | tee cwt-test-output.log
      - name: Upload CWT test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cwt-test-results-${{ github.sha }}
          path: cwt-test-output.log
          if-no-files-found: ignore
