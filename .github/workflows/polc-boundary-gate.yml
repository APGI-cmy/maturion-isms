name: POLC Boundary Validation Gate

# Authority: FOREMAN_AUTHORITY_AND_SUPERVISION_MODEL.md, LIVING_AGENT_SYSTEM.md v6.2.0
# Purpose: Prevent Foreman from implementing new features; allow supervision corrections
# Issue: #193 - Implement POLC Boundary Validation Gate (refined per Issue #[current])
# Contract: Foreman-ISMS Agent Contract v2.2.0, Section 3.6 (Merge Gate Enforcement Specification)
# Refinement: Distinguish implementation (prohibited) from supervision (permitted)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read

jobs:
  polc-boundary-validation:
    name: "Merge Gate Interface / polc-boundary/validation"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check 1 - Detect Foreman Implementation Commits
        id: check1
        run: |
          echo "=== Check 1: Detect Foreman-Authored Implementation Commits ==="
          echo ""
          echo "Refined Logic: Block implementation, allow supervision corrections"
          echo ""

          # Get base branch
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          echo "Base branch: $BASE_BRANCH"

          # Get all commits in this PR
          COMMITS=$(git log origin/$BASE_BRANCH..HEAD --pretty=format:"%H|%an|%ae")

          # Foreman identity patterns
          FOREMAN_PATTERNS=(
            "copilot-swe-agent\[bot\]"
            "Copilot"
            "198982749+Copilot@users.noreply.github.com"
          )

          VIOLATION_FOUND=false
          VIOLATION_FILES=""
          VIOLATION_COMMITS=""
          SUPERVISION_FILES=""

          echo "Checking commits for Foreman authorship..."
          echo ""

          while IFS='|' read -r commit_sha commit_author commit_email; do
            IS_FOREMAN=false

            # Check if commit is by Foreman
            for pattern in "${FOREMAN_PATTERNS[@]}"; do
              if [[ "$commit_author" =~ $pattern ]] || [[ "$commit_email" =~ $pattern ]]; then
                IS_FOREMAN=true
                break
              fi
            done

            if [ "$IS_FOREMAN" = true ]; then
              echo "Foreman commit detected: $commit_sha ($commit_author)"

              # Get files changed in this commit
              FILES=$(git diff-tree --no-commit-id --name-only -r $commit_sha)

              # Check each file
              while IFS= read -r file; do
                # Skip if file doesn't exist (deleted files)
                if [ ! -f "$file" ]; then
                  continue
                fi

                # SUPERVISION CORRECTIONS (PERMITTED)
                # Documentation, config, test corrections, governance, session memory
                if [[ "$file" =~ \.md$ ]] || \
                   [[ "$file" =~ README ]] || \
                   [[ "$file" =~ CHANGELOG ]] || \
                   [[ "$file" =~ \.config\.(ts|js|json)$ ]] || \
                   [[ "$file" =~ package\.json$ ]] || \
                   [[ "$file" =~ tsconfig\.json$ ]] || \
                   [[ "$file" =~ ^\.agent-workspace/foreman ]] || \
                   [[ "$file" =~ ^\.agent-admin/ ]] || \
                   [[ "$file" =~ ^governance/ ]] || \
                   [[ "$file" =~ /02-architecture/ ]] || \
                   [[ "$file" =~ BUILD_PROGRESS_TRACKER\.md$ ]]; then
                  echo "  ‚úÖ SUPERVISION: $file (documentation/config/governance)"
                  SUPERVISION_FILES="${SUPERVISION_FILES}\n  - ${file}"
                  continue
                fi

                # IMPLEMENTATION DETECTION (PROHIBITED)
                # Check for production code patterns
                if [[ "$file" =~ ^modules/.*/src/.*\.(ts|tsx|js|jsx)$ ]] || \
                   [[ "$file" =~ ^apps/.*/src/.*\.(ts|tsx|js|jsx)$ ]] || \
                   [[ "$file" =~ ^packages/.*/src/.*\.(ts|tsx|js|jsx)$ ]]; then
                  
                  echo "  üîç ANALYZING: $file (production code pattern)"
                  
                  # Get file diff to check for implementation indicators
                  DIFF=$(git show $commit_sha -- "$file" 2>/dev/null || echo "")
                  
                  # Check for implementation patterns (new capability indicators)
                  IMPLEMENTATION_DETECTED=false
                  
                  # New component/function/class exports
                  if echo "$DIFF" | grep -qE '^\+.*export (function|class|const|interface|type)'; then
                    echo "    - New export detected (possible new capability)"
                    IMPLEMENTATION_DETECTED=true
                  fi
                  
                  # New React components
                  if echo "$DIFF" | grep -qE '^\+.*(function|const) [A-Z][a-zA-Z]*.*=.*\(.*\).*=>|^\+.*class [A-Z][a-zA-Z]* extends (React\.)?Component'; then
                    echo "    - New React component detected"
                    IMPLEMENTATION_DETECTED=true
                  fi
                  
                  # New API routes/handlers
                  if echo "$DIFF" | grep -qE '^\+.*(router\.|app\.|route\.)(get|post|put|delete|patch)'; then
                    echo "    - New API route/handler detected"
                    IMPLEMENTATION_DETECTED=true
                  fi
                  
                  # New state management
                  if echo "$DIFF" | grep -qE '^\+.*(createSlice|createReducer|useState|useReducer)'; then
                    echo "    - New state management detected"
                    IMPLEMENTATION_DETECTED=true
                  fi
                  
                  # Large additions (>50 lines) suggesting feature expansion
                  LINES_ADDED=$(echo "$DIFF" | grep -c '^+[^+]' || echo "0")
                  if [ "$LINES_ADDED" -gt 50 ]; then
                    echo "    - Large addition detected ($LINES_ADDED lines) - possible feature expansion"
                    IMPLEMENTATION_DETECTED=true
                  fi
                  
                  if [ "$IMPLEMENTATION_DETECTED" = true ]; then
                    VIOLATION_FOUND=true
                    VIOLATION_FILES="${VIOLATION_FILES}\n  - ${file}"
                    VIOLATION_COMMITS="${VIOLATION_COMMITS}\n  - ${commit_sha} (${commit_author})"
                    echo "  ‚ùå IMPLEMENTATION VIOLATION: $file"
                  else
                    echo "  ‚ö†Ô∏è  AMBIGUOUS: $file (production file modified, but no clear implementation detected)"
                    echo "    Manual review recommended"
                  fi
                fi

                # TEST FILES - Check if new test or test correction
                if [[ "$file" =~ \.test\.(ts|tsx|js|jsx)$ ]]; then
                  echo "  üîç ANALYZING TEST: $file"
                  
                  # Get file diff
                  DIFF=$(git show $commit_sha -- "$file" 2>/dev/null || echo "")
                  
                  # Check if this is a new test file (implementation)
                  if git log --diff-filter=A --oneline origin/$BASE_BRANCH..HEAD -- "$file" | grep -q "$commit_sha"; then
                    echo "    - New test file detected (feature test creation)"
                    VIOLATION_FOUND=true
                    VIOLATION_FILES="${VIOLATION_FILES}\n  - ${file} (new test file)"
                    VIOLATION_COMMITS="${VIOLATION_COMMITS}\n  - ${commit_sha} (${commit_author})"
                    echo "  ‚ùå IMPLEMENTATION VIOLATION: New test file for new feature"
                  else
                    # Existing test file - likely correction
                    echo "    - Existing test modified (likely test correction)"
                    SUPERVISION_FILES="${SUPERVISION_FILES}\n  - ${file} (test correction)"
                    echo "  ‚úÖ SUPERVISION: Test correction"
                  fi
                fi
              done <<< "$FILES"
            fi
          done <<< "$COMMITS"

          echo ""
          echo "=== ANALYSIS SUMMARY ==="
          echo ""

          if [ -n "$SUPERVISION_FILES" ]; then
            echo "‚úÖ Supervision Corrections Detected (Permitted):"
            echo -e "$SUPERVISION_FILES"
            echo ""
          fi

          if [ "$VIOLATION_FOUND" = true ]; then
            echo "‚ùå POLC BOUNDARY VIOLATION DETECTED"
            echo ""
            echo "Foreman authored commits implementing new features/capabilities."
            echo ""
            echo "Implementation Files Detected:${VIOLATION_FILES}"
            echo ""
            echo "Commits:${VIOLATION_COMMITS}"
            echo ""
            echo "Foreman MUST NOT implement new features. Builders implement; Foreman supervises."
            echo ""
            echo "Permitted: Documentation, config, test corrections, governance artifacts"
            echo "Prohibited: New components, API routes, business logic, feature expansion"
            echo ""
            echo "Action Required:"
            echo "  1. Close this PR"
            echo "  2. Create builder delegation issues"
            echo "  3. Assign builders to implement"
            echo "  4. Foreman supervises (does not implement)"
            echo ""
            echo "Override: CS2 only (for ambiguous cases or justified exceptions)"
            echo ""
            exit 1
          else
            echo "‚úÖ Check 1 PASSED - No Foreman implementation commits detected"
            echo ""
            echo "Foreman performed supervision corrections only (or no production changes)."
            echo ""
            echo "check1_status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Check 2 - Validate Builder Involvement
        id: check2
        if: always()
        run: |
          echo "=== Check 2: Validate Builder Involvement ==="
          echo ""
          echo "Refined Logic: Skip if only supervision corrections detected"
          echo ""

          # Get base branch
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"

          # Check if production/implementation code was changed
          CHANGED_FILES=$(git diff --name-only origin/$BASE_BRANCH...HEAD)

          IMPLEMENTATION_CHANGED=false
          SUPERVISION_ONLY=true

          while IFS= read -r file; do
            # Skip supervision files
            if [[ "$file" =~ \.md$ ]] || \
               [[ "$file" =~ README ]] || \
               [[ "$file" =~ CHANGELOG ]] || \
               [[ "$file" =~ \.config\.(ts|js|json)$ ]] || \
               [[ "$file" =~ package\.json$ ]] || \
               [[ "$file" =~ tsconfig\.json$ ]] || \
               [[ "$file" =~ ^\.agent-workspace/ ]] || \
               [[ "$file" =~ ^\.agent-admin/ ]] || \
               [[ "$file" =~ ^governance/ ]] || \
               [[ "$file" =~ /02-architecture/ ]] || \
               [[ "$file" =~ BUILD_PROGRESS_TRACKER\.md$ ]]; then
              continue
            fi

            # Check for implementation files
            if [[ "$file" =~ ^modules/.*/src/.*\.(ts|tsx|js|jsx)$ ]] || \
               [[ "$file" =~ ^apps/.*/src/.*\.(ts|tsx|js|jsx)$ ]] || \
               [[ "$file" =~ ^packages/.*/src/.*\.(ts|tsx|js|jsx)$ ]]; then
              IMPLEMENTATION_CHANGED=true
              SUPERVISION_ONLY=false
              break
            fi

            # Check for new test files (implementation)
            if [[ "$file" =~ \.test\.(ts|tsx|js|jsx)$ ]]; then
              # Check if this is a new test file
              if git log --diff-filter=A --oneline origin/$BASE_BRANCH..HEAD -- "$file" | grep -q .; then
                IMPLEMENTATION_CHANGED=true
                SUPERVISION_ONLY=false
                break
              fi
            fi
          done <<< "$CHANGED_FILES"

          if [ "$SUPERVISION_ONLY" = true ]; then
            echo "‚ÑπÔ∏è  Only supervision corrections detected (docs, config, test fixes)"
            echo "   No builder involvement required for supervision work."
            echo ""
            echo "check2_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "$IMPLEMENTATION_CHANGED" = false ]; then
            echo "‚ÑπÔ∏è  No implementation code changes detected - skipping builder involvement check"
            echo "check2_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Implementation code changes detected. Checking for builder involvement..."
          echo ""

          # Check for builder commits
          COMMITS=$(git log origin/$BASE_BRANCH..HEAD --pretty=format:"%H|%an|%ae")

          BUILDER_PATTERNS=(
            "ui-builder"
            "api-builder"
            "schema-builder"
            "integration-builder"
            "qa-builder"
          )

          BUILDER_FOUND=false

          while IFS='|' read -r commit_sha commit_author commit_email; do
            for pattern in "${BUILDER_PATTERNS[@]}"; do
              if [[ "$commit_author" =~ $pattern ]] || [[ "$commit_email" =~ $pattern ]]; then
                BUILDER_FOUND=true
                echo "‚úÖ Builder commit found: $commit_sha ($commit_author)"
                break 2
              fi
            done
          done <<< "$COMMITS"

          # Check for builder completion reports
          if [ "$BUILDER_FOUND" = false ]; then
            if ls .agent-workspace/*/memory/*COMPLETION* 1> /dev/null 2>&1 || \
               ls .agent-workspace/*/COMPLETION* 1> /dev/null 2>&1; then
              BUILDER_FOUND=true
              echo "‚úÖ Builder completion reports found in .agent-workspace/"
            fi
          fi

          echo ""

          if [ "$BUILDER_FOUND" = false ]; then
            echo "‚ö†Ô∏è  WARNING: NO BUILDER INVOLVEMENT DETECTED"
            echo ""
            echo "Implementation code changed but no builder artifacts found."
            echo ""
            echo "Expected: Builder commits OR completion reports in .agent-workspace/"
            echo ""
            echo "If Foreman supervised builders, where are the builder artifacts?"
            echo "If Foreman implemented directly, this should have been caught in Check 1."
            echo ""
            echo "This is a WARNING. Manual review required."
            echo ""
            # Set to passed but log warning
            echo "check2_status=warning" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Check 2 PASSED - Builder involvement confirmed"
            echo "check2_status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Check 3 - Validate Session Memory Presence
        id: check3
        if: always()
        run: |
          echo "=== Check 3: Validate Session Memory Presence ==="
          echo ""

          # Check for Foreman session memory
          SESSION_MEMORY_FOUND=false

          if ls .agent-workspace/foreman*/memory/session-*.md 1> /dev/null 2>&1; then
            SESSION_MEMORY_FOUND=true
            SESSION_FILES=$(ls .agent-workspace/foreman*/memory/session-*.md 2>/dev/null)
            echo "‚úÖ Session memory files found:"
            echo "$SESSION_FILES" | while read -r file; do
              echo "  - $file"
            done
          fi

          echo ""

          if [ "$SESSION_MEMORY_FOUND" = false ]; then
            echo "‚ùå SESSION MEMORY REQUIRED"
            echo ""
            echo "Every Foreman session MUST create session memory."
            echo ""
            echo "Expected: .agent-workspace/foreman*/memory/session-NNN-YYYYMMDD.md"
            echo ""
            echo "Session memory must document:"
            echo "  - Builder delegation (if implementation work occurred)"
            echo "  - POLC supervision evidence"
            echo "  - Decisions and lessons learned"
            echo ""
            echo "Per Living Agent System v6.2.0."
            echo ""
            exit 1
          else
            echo "‚úÖ Check 3 PASSED - Session memory present"

            # Validate session memory doesn't show FM writing code
            echo ""
            echo "Checking session memory for POLC violations..."

            POLC_VIOLATION_IN_MEMORY=false
            for session_file in .agent-workspace/foreman*/memory/session-*.md; do
              if [ -f "$session_file" ]; then
                # Check for indicators that FM wrote code (positive assertions only)
                # Skip lines with negations (NOT, did not, didn't, no)
                if grep -iE "(implemented|wrote|created|modified).*production.*code|FM.*implemented|Foreman.*wrote.*code" "$session_file" | \
                   grep -qviE "did NOT|NOT.*implement|NOT.*write|did not|didn't|no production"; then
                  echo "‚ö†Ô∏è  WARNING: Session memory may indicate FM wrote code: $session_file"
                  POLC_VIOLATION_IN_MEMORY=true
                fi
              fi
            done

            if [ "$POLC_VIOLATION_IN_MEMORY" = true ]; then
              echo ""
              echo "‚ùå SESSION MEMORY INDICATES POLC VIOLATION"
              echo ""
              echo "Session memory contains evidence that Foreman implemented new features."
              echo "This violates the POLC-Only Constraint."
              echo ""
              echo "Note: Supervision corrections (docs, config, test fixes) are permitted."
              echo ""
              exit 1
            fi

            echo "‚úÖ Session memory validates POLC compliance"
            echo "check3_status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Check 4 - Validate Evidence Artifact Bundle
        id: check4
        if: always()
        run: |
          echo "=== Check 4: Validate Evidence Artifact Bundle ==="
          echo ""

          VALIDATION_FAILED=false

          # Check for .agent-admin/ directory
          if [ ! -d ".agent-admin" ]; then
            echo "‚ùå .agent-admin/ directory missing"
            VALIDATION_FAILED=true
          else
            echo "‚úÖ .agent-admin/ directory exists"
          fi

          # Check required subdirectories
          REQUIRED_DIRS=(
            ".agent-admin/prehandover"
            ".agent-admin/gates"
            ".agent-admin/improvements"
          )

          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "‚ö†Ô∏è  $dir missing (may be created during build)"
            else
              echo "‚úÖ $dir exists"
            fi
          done

          echo ""

          if [ "$VALIDATION_FAILED" = true ]; then
            echo "‚ùå EVIDENCE ARTIFACT BUNDLE REQUIRED"
            echo ""
            echo "Expected structure:"
            echo "  .agent-admin/prehandover/"
            echo "  .agent-admin/gates/"
            echo "  .agent-admin/improvements/"
            echo ""
            echo "Per EVIDENCE_ARTIFACT_BUNDLE_STANDARD.md"
            echo ""
            exit 1
          else
            echo "‚úÖ Check 4 PASSED - Evidence artifact bundle validated"
            echo "check4_status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Report Final Verdict
        if: always()
        run: |
          echo "=== POLC Boundary Validation - Final Verdict ==="
          echo ""
          echo "Check 1 (Foreman Commits):    ${{ steps.check1.outputs.check1_status || 'failed' }}"
          echo "Check 2 (Builder Involvement): ${{ steps.check2.outputs.check2_status || 'failed' }}"
          echo "Check 3 (Session Memory):      ${{ steps.check3.outputs.check3_status || 'failed' }}"
          echo "Check 4 (Evidence Bundle):     ${{ steps.check4.outputs.check4_status || 'failed' }}"
          echo ""

          if [[ "${{ steps.check1.outputs.check1_status }}" != "passed" ]] || \
             [[ "${{ steps.check3.outputs.check3_status }}" != "passed" ]] || \
             [[ "${{ steps.check4.outputs.check4_status }}" != "passed" ]]; then
            echo "‚ùå POLC BOUNDARY VALIDATION FAILED"
            echo ""
            echo "One or more required checks failed. Review the logs above."
            echo ""
            exit 1
          elif [[ "${{ steps.check2.outputs.check2_status }}" == "warning" ]]; then
            echo "‚ö†Ô∏è  POLC BOUNDARY VALIDATION PASSED WITH WARNINGS"
            echo ""
            echo "Manual review recommended for builder involvement."
            echo ""
          else
            echo "‚úÖ POLC BOUNDARY VALIDATION PASSED"
            echo ""
            echo "All checks passed successfully."
            echo "Foreman delegation model verified."
            echo ""
          fi
