name: Ripple Integration

# TERMINOLOGY (per ECOSYSTEM_VOCABULARY.md v1.1.0 and LAYERING_AND_RIPPLING_AUTOMATION_STRATEGY.md v1.0.0):
# - LAYERING DOWN : Cross-repo distribution of governance artefacts (upstream ‚Äî foreman-governance repo).
# - RIPPLING      : Within-repo integration/synchronisation ‚Äî this workflow.
#
# This workflow is the consumer-side listener.  It is triggered by the GitHub issues
# that the upstream `governance-layer-down-dispatch.yml` workflow creates in this repo
# (labels: governance + layer-down).  It then:
#   1. Runs the existing align-governance.sh script to pull canonical changes.
#   2. Detects whether any .github/agents/*.md files are in the diff.
#   3. If agent files changed  ‚Üí creates a DRAFT ripple PR + escalation doc (CS2 gate).
#   4. If no agent files       ‚Üí creates a normal ripple PR and enables auto-merge.
#   5. Comments on the issue with the outcome.
#
# Authority: LAYERING_AND_RIPPLING_AUTOMATION_STRATEGY.md v1.0.0
#            CROSS_REPOSITORY_LAYER_DOWN_PROTOCOL.md
#            CS2_AGENT_FILE_AUTHORITY_MODEL.md

on:
  issues:
    types: [opened, edited, labeled]

  # Manual trigger (testing / re-runs)
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Layer-down issue number to process'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # GATE: only process issues that carry both governance labels
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  check-labels:
    name: Check Issue Labels
    runs-on: ubuntu-latest
    outputs:
      should_process: ${{ steps.check.outputs.should_process }}
    steps:
      - name: Evaluate labels
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_process=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          HAS_GOVERNANCE="${{ contains(github.event.issue.labels.*.name, 'governance') }}"
          HAS_LAYERDOWN="${{ contains(github.event.issue.labels.*.name, 'layer-down') }}"

          if [ "$HAS_GOVERNANCE" = "true" ] && [ "$HAS_LAYERDOWN" = "true" ]; then
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "Issue carries governance + layer-down labels ‚Äî proceeding"
          else
            echo "should_process=false" >> $GITHUB_OUTPUT
            echo "Issue does not carry both required labels ‚Äî skipping"
          fi

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # MAIN: ripple integration
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ripple-integration:
    name: Ripple Integration
    runs-on: ubuntu-latest
    needs: check-labels
    if: needs.check-labels.outputs.should_process == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MATURION_BOT_TOKEN || github.token }}

      - name: Configure Git
        run: |
          git config --global user.name "Maturion Bot"
          git config --global user.email "bot@maturion.ai"

      # ‚îÄ‚îÄ Resolve the issue number regardless of trigger type ‚îÄ‚îÄ
      - name: Resolve issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      # ‚îÄ‚îÄ Detect agent-file gate from issue body ‚îÄ‚îÄ
      - name: Detect agent file gate
        id: agent_gate
        env:
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
        run: |
          ISSUE_BODY=$(gh issue view "${{ steps.issue.outputs.number }}" \
            --repo ${{ github.repository }} \
            --json body --jq '.body' 2>/dev/null || echo "")

          if echo "$ISSUE_BODY" | grep -q "Agent File Detection Gate"; then
            echo "agent_files_changed=true" >> $GITHUB_OUTPUT
            echo "Agent File Detection Gate found in issue ‚Äî CS2 escalation required"
          else
            echo "agent_files_changed=false" >> $GITHUB_OUTPUT
            echo "No Agent File Detection Gate in issue ‚Äî standard ripple path"
          fi

      # ‚îÄ‚îÄ Run canonical alignment script ‚îÄ‚îÄ
      - name: Run governance alignment
        id: align
        run: |
          set +e
          bash .github/scripts/align-governance.sh
          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            if git status --porcelain | grep -q '^'; then
              echo "drift_detected=true" >> $GITHUB_OUTPUT
            else
              echo "drift_detected=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "alignment script exited with code $EXIT_CODE"
            exit $EXIT_CODE
          fi

      # ‚îÄ‚îÄ Check for existing alignment PR to avoid duplicates ‚îÄ‚îÄ
      # When triggered by an issue created by the scheduled alignment workflow,
      # the scheduled workflow may have already created a PR.  If so, skip PR
      # creation and just comment on the issue with the existing PR reference.
      # Note: checks only the stable 'governance-alignment-auto' branch used by
      # governance-alignment-schedule.yml.  PRs from governance-ripple-sync.yml
      # use 'ripple/governance-sync-{run_id}' and are excluded intentionally ‚Äî
      # that path creates its own issue and PR atomically.
      - name: Check for existing alignment PR
        id: existing_pr
        if: steps.align.outputs.drift_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
        run: |
          EXISTING=$(gh pr list \
            --repo ${{ github.repository }} \
            --state open \
            --label "governance" \
            --label "automated" \
            --json number,headRefName,title \
            --jq '.[] | select(.headRefName == "governance-alignment-auto") | .number' \
            2>/dev/null | head -1 || echo "")
          if [ -n "$EXISTING" ]; then
            echo "pr_number=${EXISTING}" >> $GITHUB_OUTPUT
            echo "skip_pr_creation=true" >> $GITHUB_OUTPUT
            echo "Existing governance alignment PR #${EXISTING} found ‚Äî skipping duplicate PR creation"
          else
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "skip_pr_creation=false" >> $GITHUB_OUTPUT
            echo "No existing alignment PR ‚Äî proceeding with ripple PR creation"
          fi

      # ‚îÄ‚îÄ Verify changed files for agent contracts (git diff check) ‚îÄ‚îÄ
      - name: Check diff for agent contracts
        id: diff_check
        if: steps.align.outputs.drift_detected == 'true'
        run: |
          AGENT_DIFF=$(git diff --name-only HEAD | grep -E '^\.github/agents/.*\.md$' || true)
          if [ -n "$AGENT_DIFF" ]; then
            echo "has_agent_files=true" >> $GITHUB_OUTPUT
            echo "Agent contract files in diff: $AGENT_DIFF"
          else
            echo "has_agent_files=false" >> $GITHUB_OUTPUT
          fi

      # ‚îÄ‚îÄ Determine final escalation decision ‚îÄ‚îÄ
      - name: Determine escalation
        id: escalation
        run: |
          GATE="${{ steps.agent_gate.outputs.agent_files_changed }}"
          DIFF="${{ steps.diff_check.outputs.has_agent_files }}"
          if [ "$GATE" = "true" ] || [ "$DIFF" = "true" ]; then
            echo "require_cs2=true" >> $GITHUB_OUTPUT
          else
            echo "require_cs2=false" >> $GITHUB_OUTPUT
          fi

      # ‚îÄ‚îÄ Collect alignment metadata ‚îÄ‚îÄ
      - name: Collect alignment metadata
        id: metadata
        if: steps.align.outputs.drift_detected == 'true'
        run: |
          DRIFT_REPORT=$(ls -t .agent-admin/governance/drift-report-*.md 2>/dev/null | head -1)
          if [ -n "$DRIFT_REPORT" ]; then
            CANONICAL_COMMIT=$(grep "Canonical Commit" "$DRIFT_REPORT" | sed 's/.*: //')
            CANONICAL_VERSION=$(grep "Canonical Version" "$DRIFT_REPORT" | sed 's/.*: //')
            FILES_UPDATED=$(grep "Files Layered Down" "$DRIFT_REPORT" | sed 's/.*: //')
            echo "canonical_commit=$CANONICAL_COMMIT" >> $GITHUB_OUTPUT
            echo "canonical_version=$CANONICAL_VERSION" >> $GITHUB_OUTPUT
            echo "files_updated=$FILES_UPDATED" >> $GITHUB_OUTPUT
            echo "drift_report=$DRIFT_REPORT" >> $GITHUB_OUTPUT
          fi

      # ‚îÄ‚îÄ Create escalation document when agent files touched ‚îÄ‚îÄ
      # Defect 3 fix: write each line via echo so headings appear at column 0
      # in the committed file without breaking the YAML block scalar.
      - name: Create escalation document
        if: >
          steps.align.outputs.drift_detected == 'true' &&
          steps.escalation.outputs.require_cs2 == 'true'
        run: |
          DATESTAMP=$(date -u +"%Y-%m-%d")
          INBOX=".agent-workspace/governance-liaison/escalation-inbox"
          mkdir -p "$INBOX"
          ESCALATION_FILE="${INBOX}/agent-contract-ripple-escalation-${DATESTAMP}.md"
          {
            echo '# Escalation: Agent Contract Ripple ‚Äî CS2 Approval Required'
            echo ''
            echo '## Type'
            echo 'BLOCKER'
            echo ''
            echo '## Description'
            echo 'A governance layer-down triggered a ripple that includes changes to'
            echo 'agent contract files (`.github/agents/*.md`).'
            echo ''
            echo 'Per **CS2_AGENT_FILE_AUTHORITY_MODEL.md** and'
            echo '**AGENT_CONTRACT_PROTECTION_PROTOCOL.md**, only CS2 (Johan Ras) may'
            echo 'approve and merge changes to agent contracts.'
            echo ''
            echo '**The ripple PR has been created as DRAFT and must not be merged until'
            echo 'CS2 explicitly approves it.**'
            echo ''
            echo '## Context'
            echo "- Session: ripple-integration-${{ github.run_id }}"
            echo "- Triggered by: Issue #${{ steps.issue.outputs.number }}"
            echo "- Canonical commit: ${{ steps.metadata.outputs.canonical_commit }}"
            echo "- Canonical version: ${{ steps.metadata.outputs.canonical_version }}"
            echo "- Files updated: ${{ steps.metadata.outputs.files_updated }}"
            echo "- Drift report: ${{ steps.metadata.outputs.drift_report }}"
            echo ''
            echo '## Recommendation'
            echo '1. CS2 reviews the DRAFT ripple PR'
            echo '2. CS2 approves and merges after review'
            echo '3. Move this file to `escalation-archive/` after resolution'
            echo ''
            echo '## Evidence'
            echo "- Drift report: \`${{ steps.metadata.outputs.drift_report }}\`"
            echo "- Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo ''
            echo '---'
            echo "Created: ${DATESTAMP} | Authority: CS2 | Session: ${{ github.run_id }}"
          } > "$ESCALATION_FILE"
          echo "Escalation document created: $ESCALATION_FILE"

      # ‚îÄ‚îÄ Record layer-down receipt ‚îÄ‚îÄ
      # Defect 1 fix: this step runs BEFORE the PR creation steps so the JSON
      # file is staged and included in the ripple PR commit.
      - name: Record layer-down receipt
        if: steps.align.outputs.drift_detected == 'true'
        run: |
          mkdir -p .agent-admin/ripple
          DATESTAMP=$(date -u +%Y%m%dT%H%M%SZ)
          RECORD=".agent-admin/ripple/layer-down-received-${DATESTAMP}.json"
          jq -n \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg issue "${{ steps.issue.outputs.number }}" \
            --arg commit "${{ steps.metadata.outputs.canonical_commit }}" \
            --arg cs2 "${{ steps.escalation.outputs.require_cs2 }}" \
            '{schema_version:"1.0.0",type:"layer_down_received",timestamp:$ts,source_issue:$issue,canonical_commit:$commit,requires_cs2_approval:($cs2=="true"),escalated:($cs2=="true")}' \
            > "$RECORD"
          echo "Receipt recorded: $RECORD"

      # ‚îÄ‚îÄ Create PR ‚Äî standard path (no agent files changed) ‚îÄ‚îÄ
      # Defect 2 fix: separate steps with literal draft: false / draft: true
      - name: Create ripple PR (standard ‚Äî no agent files)
        if: >
          steps.align.outputs.drift_detected == 'true' &&
          steps.escalation.outputs.require_cs2 == 'false' &&
          steps.existing_pr.outputs.skip_pr_creation != 'true'
        id: create_pr_standard
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
          commit-message: |
            Ripple: propagate governance layer-down (issue #${{ steps.issue.outputs.number }})
            Canonical commit: ${{ steps.metadata.outputs.canonical_commit }}
            Files updated: ${{ steps.metadata.outputs.files_updated }}
            Agent files changed: false
          branch: ripple/layer-down-${{ github.run_id }}
          force-push: true
          delete-branch: true
          draft: false
          title: '[Ripple] Propagate governance layer-down'
          body: |
            ## Ripple Integration
            This PR propagates governance artefacts from the upstream layer-down.
            ### Source
            - **Layer-down issue**: #${{ steps.issue.outputs.number }}
            - **Canonical commit**: `${{ steps.metadata.outputs.canonical_commit }}`
            - **Canonical version**: `${{ steps.metadata.outputs.canonical_version }}`
            - **Files updated**: ${{ steps.metadata.outputs.files_updated }}
            ### Agent File Gate
            ‚úÖ No agent contract files changed ‚Äî standard auto-merge path.
            ---
            **Authority**: LAYERING_AND_RIPPLING_AUTOMATION_STRATEGY.md v1.0.0
            **Closes**: #${{ steps.issue.outputs.number }}
          labels: |
            governance
            ripple
            automated
            agent:liaison
          assignees: APGI-cmy

      # ‚îÄ‚îÄ Create PR ‚Äî CS2 DRAFT path (agent files changed) ‚îÄ‚îÄ
      - name: Create ripple PR (DRAFT ‚Äî CS2 required)
        if: >
          steps.align.outputs.drift_detected == 'true' &&
          steps.escalation.outputs.require_cs2 == 'true' &&
          steps.existing_pr.outputs.skip_pr_creation != 'true'
        id: create_pr_draft
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
          commit-message: |
            Ripple: propagate governance layer-down (issue #${{ steps.issue.outputs.number }})
            Canonical commit: ${{ steps.metadata.outputs.canonical_commit }}
            Files updated: ${{ steps.metadata.outputs.files_updated }}
            Agent files changed: true
          branch: ripple/layer-down-${{ github.run_id }}
          force-push: true
          delete-branch: true
          draft: true
          title: '[Ripple][DRAFT ‚Äî CS2 Required] Propagate governance layer-down'
          body: |
            ## Ripple Integration
            This PR propagates governance artefacts from the upstream layer-down.
            ### Source
            - **Layer-down issue**: #${{ steps.issue.outputs.number }}
            - **Canonical commit**: `${{ steps.metadata.outputs.canonical_commit }}`
            - **Canonical version**: `${{ steps.metadata.outputs.canonical_version }}`
            - **Files updated**: ${{ steps.metadata.outputs.files_updated }}
            ### Agent File Gate
            ‚õî **Agent contract files changed ‚Äî CS2 approval required.** Auto-merge is DISABLED. See `.agent-workspace/governance-liaison/escalation-inbox/` for escalation document.
            ---
            **Authority**: LAYERING_AND_RIPPLING_AUTOMATION_STRATEGY.md v1.0.0
            **Closes**: #${{ steps.issue.outputs.number }}
          labels: |
            governance
            ripple
            automated
            agent:liaison
          assignees: APGI-cmy

      # ‚îÄ‚îÄ Resolve PR number from whichever step ran ‚îÄ‚îÄ
      - name: Resolve PR number
        id: pr_number
        run: |
          NUMBER="${{ steps.create_pr_standard.outputs.pull-request-number }}"
          if [ -z "$NUMBER" ]; then
            NUMBER="${{ steps.create_pr_draft.outputs.pull-request-number }}"
          fi
          # Fall back to the existing PR found by the duplicate-check step
          if [ -z "$NUMBER" ]; then
            NUMBER="${{ steps.existing_pr.outputs.pr_number }}"
          fi
          echo "number=$NUMBER" >> $GITHUB_OUTPUT

      # ‚îÄ‚îÄ Enable auto-merge only when no CS2 gate required ‚îÄ‚îÄ
      - name: Enable auto-merge
        if: >
          steps.align.outputs.drift_detected == 'true' &&
          steps.escalation.outputs.require_cs2 == 'false' &&
          steps.pr_number.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
        run: |
          PR_NUMBER="${{ steps.pr_number.outputs.number }}"
          echo "Enabling auto-merge for ripple PR #$PR_NUMBER"
          gh pr merge "$PR_NUMBER" \
            --repo ${{ github.repository }} \
            --auto \
            --squash \
            --delete-branch || echo "Auto-merge could not be enabled ‚Äî branch protection may require checks to pass first"

      # ‚îÄ‚îÄ Comment on the issue ‚îÄ‚îÄ
      - name: Comment on issue
        if: always()
        env:
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
        run: |
          DRIFT="${{ steps.align.outputs.drift_detected }}"
          REQUIRE_CS2="${{ steps.escalation.outputs.require_cs2 }}"
          PR_NUMBER="${{ steps.pr_number.outputs.number }}"
          COMMIT="${{ steps.metadata.outputs.canonical_commit }}"
          FILES="${{ steps.metadata.outputs.files_updated }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          SKIP_PR="${{ steps.existing_pr.outputs.skip_pr_creation }}"

          if [ "$DRIFT" = "true" ] && [ -n "$PR_NUMBER" ]; then
            if [ "$SKIP_PR" = "true" ]; then
              COMMENT=$(printf '%s\n\n%s\n\n%s\n%s\n%s\n\n%s\n%s' \
                '## ‚úÖ Ripple Integration ‚Äî Existing Alignment PR Referenced' \
                'Governance drift was detected. A governance alignment PR already exists (created by the scheduled alignment workflow). No duplicate PR was created.' \
                "- Existing PR: #${PR_NUMBER}" \
                "- Canonical commit: \`${COMMIT}\`" \
                "- Files updated: ${FILES}" \
                '---' \
                '*Governance Liaison ‚Äî ripple-integration.yml*')
            elif [ "$REQUIRE_CS2" = "true" ]; then
              COMMENT=$(printf '%s\n\n%s\n\n%s\n\n%s\n%s\n%s\n\n%s\n%s' \
                '## üîí Ripple Integration ‚Äî CS2 Escalation Required' \
                'Governance drift was detected and a **DRAFT** ripple PR has been created.' \
                '**Agent contract files are in the changeset. Only CS2 (Johan Ras) may approve and merge.**' \
                "- Ripple PR: #${PR_NUMBER} (DRAFT ‚Äî awaiting CS2 approval)" \
                '- Escalation doc: `.agent-workspace/governance-liaison/escalation-inbox/`' \
                "- Canonical commit: \`${COMMIT}\`" \
                '---' \
                '*Governance Liaison ‚Äî ripple-integration.yml*')
            else
              COMMENT=$(printf '%s\n\n%s\n\n%s\n%s\n%s\n%s\n\n%s\n%s' \
                '## ‚úÖ Ripple Integration ‚Äî Auto-Merge Enabled' \
                'Governance drift was detected and a ripple PR has been created.' \
                "- Ripple PR: #${PR_NUMBER}" \
                "- Canonical commit: \`${COMMIT}\`" \
                "- Files updated: ${FILES}" \
                '- Auto-merge: **enabled** (no agent contract files changed)' \
                '---' \
                '*Governance Liaison ‚Äî ripple-integration.yml*')
            fi
          elif [ "$DRIFT" = "false" ]; then
            COMMENT=$(printf '%s\n\n%s\n\n%s\n%s' \
              '## ‚úÖ Ripple Integration ‚Äî No Drift Detected' \
              'Governance is already aligned with canonical source. No PR required.' \
              '---' \
              '*Governance Liaison ‚Äî ripple-integration.yml*')
          else
            COMMENT=$(printf '%s\n\n%s\n%s\n\n%s\n%s' \
              '## ‚ö†Ô∏è Ripple Integration ‚Äî Alignment Script Error' \
              'The alignment script encountered an error. Check the workflow run for details:' \
              "${RUN_URL}" \
              '---' \
              '*Governance Liaison ‚Äî ripple-integration.yml*')
          fi

          gh issue comment "${{ steps.issue.outputs.number }}" \
            --repo ${{ github.repository }} \
            --body "$COMMENT" || echo "Could not comment on issue"
