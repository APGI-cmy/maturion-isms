name: Agent Bootstrap Inject

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]

permissions:
  issues: write
  pull-requests: write

jobs:
  inject-bootstrap-instruction:
    runs-on: ubuntu-latest
    steps:
      - name: Determine agent ID from assignees or title
        id: detect
        env:
          ASSIGNEES: ${{ toJson(github.event.issue.assignees || github.event.pull_request.assignees) }}
          TITLE: ${{ github.event.issue.title || github.event.pull_request.title }}
        run: |
          AGENT_IDS=(
            "foreman-v2-agent"
            "CodexAdvisor-agent"
            "api-builder"
            "qa-builder"
            "schema-builder"
            "ui-builder"
            "integration-builder"
            "maturion-agent"
            "mat-specialist"
            "pit-specialist"
            "governance-liaison-isms-agent"
            "independent-assurance-agent"
            "report-writer-agent"
            "risk-platform-agent"
            "maturity-scoring-agent"
            "criteria-generator-agent"
            "document-parser-agent"
          )

          DETECTED_ID=""
          for id in "${AGENT_IDS[@]}"; do
            if echo "$ASSIGNEES $TITLE" | grep -qi "$id"; then
              DETECTED_ID="$id"
              break
            fi
          done

          if [ -z "$DETECTED_ID" ]; then
            DETECTED_ID="<your-agent-id>"
          fi

          echo "agent_id=$DETECTED_ID" >> "$GITHUB_OUTPUT"

      - name: Post agent_bootstrap instruction comment
        uses: actions/github-script@v7
        with:
          script: |
            const agentId = '${{ steps.detect.outputs.agent_id }}';
            const body = `## ⚠️ AGENT PREFLIGHT REQUIRED — CALL \`agent_bootstrap\` FIRST

            **Before reading this issue/PR body, before reading any repository file, call:**

            \`\`\`
            agent_bootstrap(agent_id: "${agentId}")
            \`\`\`

            This is your **required first tool call** in every session. Skipping is a **GOV-BREACH-AIMC-W5-002 POLC violation** and will cause your PR to be blocked by the CI preflight gate.

            The \`agent_bootstrap\` tool is provided by the \`agent-bootstrap\` MCP server registered in \`.mcp.json\`. It returns your full agent contract file. Read it in full and complete Phase 1 before proceeding.

            **Authority**: CS2 (Johan Ras / @APGI-cmy)`;

            const isIssue = context.eventName === 'issues';
            if (isIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body,
              });
            }
