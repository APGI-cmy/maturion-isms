name: Governance Alignment Schedule

# Authority: CROSS_REPOSITORY_LAYER_DOWN_PROTOCOL.md, LIVING_AGENT_SYSTEM.md v6.2.0
# Purpose: Scheduled fallback for governance alignment (hourly checks)
# Complements event-driven governance-ripple-sync.yml

on:
  # Scheduled fallback - runs every hour
  schedule:
    - cron: '0 * * * *'  # Every hour on the hour
  
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      force_pr:
        description: 'Force PR creation even if no drift'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  scheduled-alignment-check:
    name: Scheduled Governance Alignment Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
      
      - name: Configure Git
        run: |
          git config --global user.name "Maturion Bot"
          git config --global user.email "bot@maturion.ai"
      
      - name: Run Governance Alignment
        id: align
        run: |
          set +e  # Don't exit on error
          
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force_pr }}" = "true" ]; then
            FORCE_FLAG="--force-pr"
          fi
          
          bash .github/scripts/align-governance.sh $FORCE_FLAG
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 0 ]; then
            # Check if drift was detected by looking at git status
            if git status --porcelain | grep -q '^'; then
              echo "drift_detected=true" >> $GITHUB_OUTPUT
              echo "Drift detected and changes staged"
            else
              echo "drift_detected=false" >> $GITHUB_OUTPUT
              echo "No drift detected"
            fi
          else
            echo "Alignment script failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
      
      # Check for existing governance alignment PRs created by this workflow only
      - name: Check for Existing Alignment PR
        id: check_existing
        if: steps.align.outputs.drift_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
        run: |
          # Only check for PRs on the stable branch used by this workflow.
          # Do NOT check ripple/ branches — those belong to governance-ripple-sync.yml
          # and are unrelated; blocking on them caused scheduled runs to be silently skipped.
          EXISTING_PR=$(gh pr list \
            --repo ${{ github.repository }} \
            --state open \
            --label "governance" \
            --label "automated" \
            --json number,headRefName \
            --jq '.[] | select(.headRefName | startswith("governance-alignment-")) | .number' \
            | head -1)

          if [ -n "$EXISTING_PR" ]; then
            echo "existing_pr=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Existing governance alignment PR found: #$EXISTING_PR — skipping new PR creation"
          else
            echo "existing_pr=" >> $GITHUB_OUTPUT
            echo "No existing governance alignment PR found"
          fi
      
      - name: Get Canonical Metadata
        id: metadata
        if: steps.align.outputs.drift_detected == 'true'
        run: |
          # Extract metadata from latest drift report
          DRIFT_REPORT=$(ls -t .agent-admin/governance/drift-report-*.md 2>/dev/null | head -1)
          
          if [ -n "$DRIFT_REPORT" ]; then
            CANONICAL_COMMIT=$(grep "Canonical Commit" "$DRIFT_REPORT" | sed 's/.*: //')
            CANONICAL_VERSION=$(grep "Canonical Version" "$DRIFT_REPORT" | sed 's/.*: //')
            FILES_UPDATED=$(grep "Files Layered Down" "$DRIFT_REPORT" | sed 's/.*: //')
            
            echo "canonical_commit=$CANONICAL_COMMIT" >> $GITHUB_OUTPUT
            echo "canonical_version=$CANONICAL_VERSION" >> $GITHUB_OUTPUT
            echo "files_updated=$FILES_UPDATED" >> $GITHUB_OUTPUT
            echo "drift_report=$DRIFT_REPORT" >> $GITHUB_OUTPUT
          fi
      
      # ── Create governance liaison issue (per CROSS_REPOSITORY_LAYER_DOWN_PROTOCOL.md) ──
      # Formally notifies the governance liaison agent of a layer-down event.
      # This issues the layer-down signal that triggers ripple-integration.yml.
      - name: Create governance liaison issue
        id: liaison_issue
        if: steps.align.outputs.drift_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
        run: |
          DATESTAMP=$(date -u +"%Y-%m-%d")
          COMMIT="${{ steps.metadata.outputs.canonical_commit }}"
          FILES="${{ steps.metadata.outputs.files_updated }}"
          VERSION="${{ steps.metadata.outputs.canonical_version }}"
          DRIFT_REPORT="${{ steps.metadata.outputs.drift_report }}"

          ISSUE_BODY=$(printf '%s\n\n%s\n\n%s\n%s\n%s\n%s\n%s\n\n%s\n\n%s\n%s' \
            '## Governance Layer-Down — Liaison Action Required' \
            'The scheduled governance alignment workflow detected drift from the canonical source and has applied the layer-down changes. Per **CROSS_REPOSITORY_LAYER_DOWN_PROTOCOL.md**, the governance liaison agent must verify, ripple, and confirm integration.' \
            "- **Trigger**: Scheduled alignment fallback (hourly)" \
            "- **Canonical commit**: \`${COMMIT}\`" \
            "- **Canonical version**: \`${VERSION}\`" \
            "- **Files layered down**: ${FILES}" \
            "- **Drift report**: \`${DRIFT_REPORT}\`" \
            '### Liaison Checklist' \
            '- [ ] Verify files layered down match canonical inventory' \
            '- [ ] Confirm AIMC canon is integrated and referenced where relevant' \
            '- [ ] Trigger internal ripple: update cross-references and linked artefacts' \
            '- [ ] Document completion in session memory and evidence artefacts' \
            '- [ ] Close this issue after ripple is confirmed complete')

          # Bootstrap required labels if missing
          gh label create "layer-down" --color "0075ca" --description "Governance layer-down event from canonical source" --repo "${{ github.repository }}" 2>/dev/null || true
          gh label create "governance" --color "e4e669" --description "Governance-related change" --repo "${{ github.repository }}" 2>/dev/null || true

          # Idempotency: skip if an open layer-down liaison issue already exists for this canonical commit
          SHORT_COMMIT="${COMMIT:0:12}"
          EXISTING_ISSUE=$(gh issue list \
            --repo "${{ github.repository }}" \
            --state open \
            --label "governance" \
            --label "layer-down" \
            --json number,title \
            --jq ".[] | select(.title | contains(\"${SHORT_COMMIT}\")) | .number" \
            2>/dev/null | head -1 || echo "")

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "issue_number=${EXISTING_ISSUE}" >> $GITHUB_OUTPUT
            echo "Existing liaison issue for commit ${SHORT_COMMIT} found: #${EXISTING_ISSUE} — skipping duplicate creation"
            exit 0
          fi

          ISSUE_NUMBER=$(gh issue create \
            --repo "${{ github.repository }}" \
            --title "[Layer-Down] Governance alignment required — ${SHORT_COMMIT}" \
            --body "$ISSUE_BODY" \
            --label "governance" \
            --label "layer-down" \
            --assignee "APGI-cmy" \
            2>/dev/null | grep -o '[0-9]*$' || echo "")

          if [ -n "$ISSUE_NUMBER" ]; then
            echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
            echo "Governance liaison issue created: #${ISSUE_NUMBER}"
          else
            echo "issue_number=" >> $GITHUB_OUTPUT
            echo "Could not create liaison issue (labels may not exist yet — ripple-integration.yml will handle via repository_dispatch path)"
          fi

      # Create OR Update PR with stable branch name.
      # PR creation is skipped when check_existing found an open alignment PR on the same
      # stable branch (governance-alignment-auto). All other workflow steps run regardless.
      - name: Create or Update Alignment PR
        if: steps.align.outputs.drift_detected == 'true' && steps.check_existing.outputs.existing_pr == ''
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
          commit-message: |
            Governance alignment - scheduled sync
            
            Canonical commit: ${{ steps.metadata.outputs.canonical_commit }}
            Files updated: ${{ steps.metadata.outputs.files_updated }}
            Triggered: Scheduled fallback check
          branch: governance-alignment-auto  # ✅ FIX #3: Stable branch name
          force-push: true  # ✅ FIX #4: Prevent race conditions with concurrent events
          delete-branch: true
          title: '[Governance Alignment] Scheduled sync with canonical governance'
          body: |
            ## Governance Alignment - Scheduled Sync
            
            This PR was automatically created by the scheduled governance alignment workflow.
            
            ### Metadata
            - **Trigger**: Scheduled fallback check (hourly)
            - **Canonical Commit**: `${{ steps.metadata.outputs.canonical_commit }}`
            - **Canonical Version**: `${{ steps.metadata.outputs.canonical_version }}`
            - **Files Updated**: ${{ steps.metadata.outputs.files_updated }}
            - **Drift Report**: `${{ steps.metadata.outputs.drift_report }}`
            
            ### Governance Alignment Protocol
            
            Per **CROSS_REPOSITORY_LAYER_DOWN_PROTOCOL.md**:
            1. ✅ Drift detected via scheduled check
            2. ✅ Canonical governance fetched from `APGI-cmy/maturion-foreman-governance`
            3. ✅ Files layered down with SHA256 verification
            4. ✅ `sync_state.json` and `CANON_INVENTORY.json` updated
            5. ✅ Evidence artifacts created in `.agent-admin/governance/`
            
            ### Review Checklist
            - [ ] Verify drift report in `.agent-admin/governance/`
            - [ ] Review file changes for correctness
            - [ ] Check `sync_state.json` updated with canonical commit
            - [ ] Ensure SHA256 checksums match canonical inventory
            - [ ] Merge gate checks pass (governance/alignment)
            
            ---
            **Authority**: LIVING_AGENT_SYSTEM.md v6.2.0  
            **Workflow**: `.github/workflows/governance-alignment-schedule.yml`  
            **Script**: `.github/scripts/align-governance.sh`
            
            ---
            **Auto-Merge**: This PR will be automatically merged once status checks pass.
          labels: |
            governance
            automated
            agent:liaison
          assignees: APGI-cmy
      
      # ✅ FIX #1: Enable auto-merge on the PR
      - name: Enable Auto-Merge
        if: steps.align.outputs.drift_detected == 'true' && steps.create_pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"
          
          echo "Enabling auto-merge for PR #$PR_NUMBER"
          
          gh pr merge "$PR_NUMBER" \
            --repo ${{ github.repository }} \
            --auto \
            --squash \
            --delete-branch || echo "Auto-merge could not be enabled (may require branch protection rules or checks)"
      
      - name: Alignment Summary
        if: always()
        run: |
          echo "======================================"
          echo "Governance Alignment Summary"
          echo "======================================"
          echo "Trigger: Scheduled fallback check"
          echo "Drift Detected: ${{ steps.align.outputs.drift_detected }}"
          
          if [ "${{ steps.align.outputs.drift_detected }}" = "true" ]; then
            echo "Canonical Commit: ${{ steps.metadata.outputs.canonical_commit }}"
            echo "Files Updated: ${{ steps.metadata.outputs.files_updated }}"
            
            if [ -n "${{ steps.check_existing.outputs.existing_pr }}" ]; then
              echo "Action: IDEMPOTENCY — existing alignment PR #${{ steps.check_existing.outputs.existing_pr }} already open — no new PR created"
            elif [ -n "${{ steps.create_pr.outputs.pull-request-number }}" ]; then
              echo "Action: Created new PR #${{ steps.create_pr.outputs.pull-request-number }}"
              echo "Auto-Merge: Enabled (squash)"
            else
              echo "Action: No PR created"
            fi
          else
            echo "Status: Governance aligned - no action needed"
          fi
          echo "======================================"