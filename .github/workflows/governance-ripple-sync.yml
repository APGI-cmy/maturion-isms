name: Governance Ripple Sync

# Authority: CROSS_REPOSITORY_LAYER_DOWN_PROTOCOL.md, LIVING_AGENT_SYSTEM.md v6.2.0
# Purpose: Event-driven governance ripple receiver for cross-repo alignment
# Complements governance-alignment-schedule.yml for scheduled fallback

on:
  # Push-based listener (MANDATORY) - Primary trigger
  repository_dispatch:
    types: [governance_ripple]
  
  # Manual trigger (for testing)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-governance:
    name: Governance Ripple Receiver
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
      
      - name: Configure Git
        run: |
          git config --global user.name "Maturion Bot"
          git config --global user.email "bot@maturion.ai"
      
      - name: Log Ripple Event
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "======================================"
          echo "Governance Ripple Event Received"
          echo "======================================"
          echo "Dispatch ID: ${{ github.event.client_payload.dispatch_id }}"
          echo "Canonical Commit: ${{ github.event.client_payload.canonical_commit }}"
          echo "Changed Paths: ${{ github.event.client_payload.changed_paths }}"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo ""
      
      - name: Run Governance Alignment
        id: align
        run: |
          set +e  # Don't exit on error
          
          bash .github/scripts/align-governance.sh
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 0 ]; then
            # Check if drift was detected by looking at git status
            if git status --porcelain | grep -q '^'; then
              echo "drift_detected=true" >> $GITHUB_OUTPUT
              echo "Drift detected and changes staged"
            else
              echo "drift_detected=false" >> $GITHUB_OUTPUT
              echo "No drift detected"
            fi
          else
            echo "Alignment script failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
      
      - name: Get Canonical Metadata
        id: metadata
        if: steps.align.outputs.drift_detected == 'true'
        run: |
          # Extract metadata from latest drift report
          DRIFT_REPORT=$(ls -t .agent-admin/governance/drift-report-*.md 2>/dev/null | head -1)
          
          if [ -n "$DRIFT_REPORT" ]; then
            CANONICAL_COMMIT=$(grep "Canonical Commit" "$DRIFT_REPORT" | sed 's/.*: //')
            CANONICAL_VERSION=$(grep "Canonical Version" "$DRIFT_REPORT" | sed 's/.*: //')
            FILES_UPDATED=$(grep "Files Layered Down" "$DRIFT_REPORT" | sed 's/.*: //')
            
            echo "canonical_commit=$CANONICAL_COMMIT" >> $GITHUB_OUTPUT
            echo "canonical_version=$CANONICAL_VERSION" >> $GITHUB_OUTPUT
            echo "files_updated=$FILES_UPDATED" >> $GITHUB_OUTPUT
            echo "drift_report=$DRIFT_REPORT" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Alignment PR
        if: steps.align.outputs.drift_detected == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
          commit-message: |
            Governance alignment - ripple sync
            
            Canonical commit: ${{ steps.metadata.outputs.canonical_commit }}
            Files updated: ${{ steps.metadata.outputs.files_updated }}
            Dispatch ID: ${{ github.event.client_payload.dispatch_id }}
          branch: governance-ripple-sync-${{ github.run_id }}
          force-push: true  # ✅ Prevent race conditions with concurrent events
          delete-branch: true
          title: '[Governance Ripple] Align with canonical governance'
          body: |
            ## Governance Ripple Sync
            
            This PR was automatically created in response to a governance ripple event from the canonical repository.
            
            ### Metadata
            - **Trigger**: Repository dispatch (governance_ripple)
            - **Dispatch ID**: `${{ github.event.client_payload.dispatch_id }}`
            - **Canonical Commit**: `${{ steps.metadata.outputs.canonical_commit || github.event.client_payload.canonical_commit }}`
            - **Canonical Version**: `${{ steps.metadata.outputs.canonical_version }}`
            - **Files Updated**: ${{ steps.metadata.outputs.files_updated }}
            - **Changed Paths**: `${{ github.event.client_payload.changed_paths }}`
            - **Drift Report**: `${{ steps.metadata.outputs.drift_report }}`
            
            ### Governance Alignment Protocol
            
            Per **CROSS_REPOSITORY_LAYER_DOWN_PROTOCOL.md**:
            1. ✅ Ripple event received from canonical source
            2. ✅ Drift detected via alignment script
            3. ✅ Files layered down with SHA256 verification
            4. ✅ `sync_state.json` and `CANON_INVENTORY.json` updated
            5. ✅ Evidence artifacts created in `.agent-admin/governance/`
            
            ### Review Checklist
            - [ ] Verify drift report in `.agent-admin/governance/`
            - [ ] Review file changes for correctness
            - [ ] Check `sync_state.json` updated with canonical commit
            - [ ] Ensure SHA256 checksums match canonical inventory
            - [ ] Merge gate checks pass (governance/alignment)
            
            ---
            **Authority**: LIVING_AGENT_SYSTEM.md v6.2.0  
            **Workflow**: `.github/workflows/governance-ripple-sync.yml`  
            **Script**: `.github/scripts/align-governance.sh`  
            **Auto-Merge**: This PR will be automatically merged once status checks pass.
          labels: |
            governance
            automated
            ripple-sync
            agent:liaison
          assignees: APGI-cmy
      
      # ✅ Enable auto-merge on the created PR
      - name: Enable Auto-Merge
        if: steps.align.outputs.drift_detected == 'true' && steps.create_pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN || github.token }}
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"
          
          echo "Enabling auto-merge for PR #$PR_NUMBER"
          
          gh pr merge "$PR_NUMBER" \
            --repo ${{ github.repository }} \
            --auto \
            --squash \
            --delete-branch || echo "Auto-merge could not be enabled (may require branch protection rules or checks)"
      
      - name: Sync Summary
        if: always()
        run: |
          echo "======================================"
          echo "Governance Ripple Sync Summary"
          echo "======================================"
          echo "Trigger: ${{ github.event_name }}"
          echo "Drift Detected: ${{ steps.align.outputs.drift_detected }}"
          
          if [ "${{ steps.align.outputs.drift_detected }}" = "true" ]; then
            echo "Canonical Commit: ${{ steps.metadata.outputs.canonical_commit }}"
            echo "Files Updated: ${{ steps.metadata.outputs.files_updated }}"
            echo "PR Created: Yes (#${{ steps.create_pr.outputs.pull-request-number }})"
            echo "Auto-Merge: Enabled (squash)"
          else
            echo "Status: Governance aligned - no action needed"
          fi
          echo "======================================"
